---
- name: Build Out the Environment
  hosts: terraform
  connection: local
  tasks:
  - block:
    - name: Populate terraform nodes file
      template:
        src: files/nodes.tf.j2
        dest: "{{ terraform_nodes_path }}"

    - name: Populate terraform nodes file
      template:
        src: files/dynamic-inventory.yml.j2
        dest: "{{ dynamic_inventory_path }}"

    - name: Run terraform apply
      terraform:
        project_path: './terraform/'
        variables: "{{ terraform_variables }}"
        force_init: true
        state: present

    always:
      - name: Cleanup terraform nodes file
        file:
          path: "{{ terraform_nodes_path }}"
          state: absent
